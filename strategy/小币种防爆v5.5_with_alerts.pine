//@version=5  
strategy("å°å¸ç§é˜²çˆ†v5.5 (å¤–éƒ¨æ‰§è¡Œ)", overlay=true, 
         default_qty_type=strategy.percent_of_equity, default_qty_value=10, pyramiding=10)

// ========================================
// ğŸ¯ é‡è¦è¯´æ˜ï¼š
// æœ¬ç­–ç•¥ç”¨äºç”Ÿæˆäº¤æ˜“ä¿¡å·ï¼Œé€šè¿‡ Webhook å‘é€ç»™å¤–éƒ¨æœåŠ¡æ‰§è¡Œ
// å›¾è¡¨ä¸Šçš„ strategy.entry() ä»…ç”¨äºå¯è§†åŒ–ï¼Œä¸æ‰§è¡ŒçœŸå®äº¤æ˜“
// ========================================

// === ç”¨æˆ·å‚æ•° ===
maxAdd        = input.int(4,   "æœ€å¤§åŠ ä»“æ¬¡æ•°")
pc_open       = input.float(1, "å¼€ä»“é˜ˆå€¼ï¼ˆ%ï¼‰")         / 100
pc_exit       = input.float(3, "æ­¢ç›ˆå¹…åº¦ï¼ˆ%ï¼‰")         / 100
high_window   = input.int(720, "æœ€é«˜ä»·å‘¨æœŸï¼ˆåˆ†é’Ÿ)")
useHighCond   = input.bool(false, "ä»…åœ¨æœ€é«˜ä»·å¼€ä»“")
trailingPct   = input.float(0.2, "ç§»åŠ¨æ­¢ç›ˆå¹…åº¦ï¼ˆ%ï¼‰", step=0.01) / 100

// === DCA åŠ ä»“é˜ˆå€¼ ===
dcaList       = input.string("4,8,12,17", "åŠ ä»“é˜ˆå€¼åˆ—è¡¨ï¼ˆ%ï¼‰ï¼Œé€—å·åˆ†éš”")
var float[]   dcaPctArr = array.new_float()
if barstate.isfirst
    for pctStr in str.split(dcaList, ",")
        array.push(dcaPctArr, str.tonumber(str.trim(pctStr)) / 100)

// === é£æ§å‚æ•° ===
maxDropPct        = input.float(20.0, "å…è®¸æœ€å¤§è·Œå¹…ï¼ˆ%ï¼‰", step=0.1) / 100
dropLookbackMins  = input.int(1, "æœ€å¤§è·Œå¹…ç»Ÿè®¡æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰")
initialMargin     = input.float(40.0, "åˆæ¬¡å¼€ä»“ä¿è¯é‡‘ (USDT)", step=0.1)
addMult           = input.float(2.0,  "åŠ ä»“æ•°é‡å€æ•°",     step=0.1)
multStep          = input.float(1.0,  "å€æ•°è°ƒæ•´æ­¥è¿›",     step=0.1)

// === EMA è¿‡æ»¤ ===
useEmaFilter  = input.bool(true, "å¯ç”¨EMAè¿‡æ»¤")
emaFastLen    = input.int(50, "EMA çŸ­æœŸ", minval=1)
emaMid1Len    = input.int(30, "EMA ä¸­æœŸ1", minval=1)
emaMid2Len    = input.int(20, "EMA ä¸­æœŸ2", minval=1)
emaSlowLen    = input.int(10, "EMA é•¿æœŸ", minval=1)

// === RSI è¿‡æ»¤ ===
useRsiFilter  = input.bool(false, "å¯ç”¨RSIè¿‡æ»¤")
rsiThreshold  = input.int(70, "RSI é˜ˆå€¼", minval=1, maxval=100)
enableRsiClose = input.bool(true, "å¯ç”¨ RSI è¾¾ä½ä¸”ç›ˆåˆ©æ—¶å¹³ä»“")
rsiCloseLen   = input.int(6, "RSI å¹³ä»“å‘¨æœŸ", minval=1)
rsiCloseLevel = input.int(30, "RSI å¹³ä»“é˜ˆå€¼", minval=1, maxval=100)

// === Webhook é…ç½® ===
signalToken = input.string("your_signal_token_here", "xiaobifang_token_2025")

// === çŠ¶æ€å˜é‡ ===
var float lastAddPrice     = na
var int   addCount         = 0
var bool  inTrade          = false
var bool  trailingActive   = false
var float trailLowestPrice = na
var float totalQty         = 0.0
var float totalCost        = 0.0
var float firstQty         = na
var float virtualEntryPrice = na

// === é€»è¾‘æ¡ä»¶ ===
priceChange = (close - close[1]) / close[1]
isHigh      = close >= ta.highest(high, high_window)
hhDrop      = ta.highest(high, dropLookbackMins)
dropFromHigh = (close - hhDrop) / hhDrop
allowDrop   = dropFromHigh >= -maxDropPct

emaFast = ta.ema(close, emaFastLen)
emaMid1 = ta.ema(close, emaMid1Len)
emaMid2 = ta.ema(close, emaMid2Len)
emaSlow = ta.ema(close, emaSlowLen)
emaCond = not useEmaFilter or (emaFast > emaMid1 and emaMid1 > emaMid2 and emaMid2 > emaSlow)

rsiValue = ta.rsi(close, 14)
rsiCond  = not useRsiFilter or (rsiValue > rsiThreshold)

// === è™šæ‹Ÿå¼€ä»“ ===
canOpen = priceChange > pc_open and (not useHighCond or isHigh) and allowDrop and emaCond and rsiCond

if not inTrade and canOpen
    inTrade           := true
    addCount          := 0
    lastAddPrice      := close
    trailingActive    := false
    totalQty          := 0.0
    totalCost         := 0.0
    firstQty          := na
    virtualEntryPrice := close
    
    // è™šæ‹Ÿå¼€ä»“ä¸å‘é€ä¿¡å·åˆ°æœåŠ¡å™¨
    // ä»…ç”¨äºå›¾è¡¨æ˜¾ç¤º
    strategy.entry("VirtualOpen", strategy.short, qty=0, comment="è™šæ‹Ÿå¼€ä»“")

// === è™šæ‹Ÿæ­¢ç›ˆ ===
if inTrade and addCount == 0 and not na(virtualEntryPrice) and close < virtualEntryPrice * (1 - pc_exit)
    inTrade           := false
    lastAddPrice      := na
    trailingActive    := false
    trailLowestPrice  := na
    totalQty          := 0.0
    totalCost         := 0.0
    virtualEntryPrice := na
    
    // ğŸ“¡ å‘é€è™šæ‹Ÿæ­¢ç›ˆä¿¡å·ï¼ˆä¸éœ€è¦çœŸå®å¹³ä»“ï¼Œå› ä¸ºæ²¡æœ‰çœŸå®ä»“ä½ï¼‰
    strategy.close("VirtualOpen", comment="è™šæ‹Ÿæ­¢ç›ˆç»“æŸ")

// === åŠ ä»“é€»è¾‘ ===
maxAdds = math.min(maxAdd, array.size(dcaPctArr))
if inTrade and addCount < maxAdds
    thisPct = array.get(dcaPctArr, addCount)
    thresholdPrice = lastAddPrice * (1 + thisPct)
    if close > thresholdPrice
        addCount += 1
        qty = initialMargin / close
        if addCount == 1
            firstQty := qty
        else
            qty := firstQty * (addMult + multStep * (addCount - 1))
        
        // ğŸ“¡ å‘é€åŠ ä»“ä¿¡å·
        prevQty = totalQty
        totalQty     += qty
        totalCost    += qty * close
        
        alertMsg = '{"action":"sell","instrument":"' + syminfo.ticker + 'USDT.P","amount":"' + str.tostring(qty) + '","marketPosition":"short","prevMarketPosition":"short","marketPositionSize":"' + str.tostring(totalQty) + '","prevMarketPositionSize":"' + str.tostring(prevQty) + '","timestamp":"' + str.tostring(time) + '","signalToken":"' + signalToken + '"}'
        alert(alertMsg, alert.freq_once_per_bar)
        
        // ä»…ç”¨äºå›¾è¡¨æ˜¾ç¤º
        strategy.entry("AddShort_" + str.tostring(addCount), strategy.short, qty=qty, comment="åŠ ä»“ #" + str.tostring(addCount))
        lastAddPrice := close
        virtualEntryPrice := na

// === å¹³å‡æˆæœ¬ ===
avgCost = totalQty == 0 ? na : totalCost / totalQty
plot(inTrade ? avgCost : na, title="æ‰‹åŠ¨å¹³å‡æˆæœ¬", color=color.green, linewidth=2)

// === RSI æ­¢ç›ˆå¹³ä»“ ===
rsiCloseVal = ta.rsi(close, rsiCloseLen)
rsiCloseTrigger = ta.crossunder(rsiCloseVal, rsiCloseLevel)
rsiCloseProfitable = false
if not na(avgCost) and totalQty > 0
    rsiCloseProfitable := close < avgCost

if enableRsiClose and inTrade and rsiCloseTrigger and rsiCloseProfitable
    // ğŸ“¡ å‘é€å¹³ä»“ä¿¡å·
    alertMsg = '{"action":"buy","instrument":"' + syminfo.ticker + 'USDT.P","amount":"' + str.tostring(totalQty) + '","marketPosition":"flat","prevMarketPosition":"short","marketPositionSize":"0","prevMarketPositionSize":"' + str.tostring(totalQty) + '","timestamp":"' + str.tostring(time) + '","signalToken":"' + signalToken + '"}'
    alert(alertMsg, alert.freq_once_per_bar)
    
    strategy.close_all(comment="RSI è¾¾ä½ä¸”ç›ˆåˆ©å¹³ä»“")
    
    inTrade          := false
    trailingActive   := false
    lastAddPrice     := na
    addCount         := 0
    totalQty         := 0
    totalCost        := 0
    trailLowestPrice := na
    firstQty         := na
    virtualEntryPrice := na

// === ç§»åŠ¨æ­¢ç›ˆ ===
tpTriggered = inTrade and not na(avgCost) and close < avgCost * (1 - pc_exit)
if tpTriggered and not trailingActive
    trailLowestPrice := close
    trailingActive   := true

if trailingActive
    trailLowestPrice := math.min(trailLowestPrice, close)
    if close > trailLowestPrice * (1 + trailingPct)
        // ğŸ“¡ å‘é€å¹³ä»“ä¿¡å·
        alertMsg = '{"action":"buy","instrument":"' + syminfo.ticker + 'USDT.P","amount":"' + str.tostring(totalQty) + '","marketPosition":"flat","prevMarketPosition":"short","marketPositionSize":"0","prevMarketPositionSize":"' + str.tostring(totalQty) + '","timestamp":"' + str.tostring(time) + '","signalToken":"' + signalToken + '"}'
        alert(alertMsg, alert.freq_once_per_bar)
        
        strategy.close_all(comment="åˆå¹¶æ­¢ç›ˆå¹³ä»“")
        
        inTrade          := false
        trailingActive   := false
        lastAddPrice     := na
        addCount         := 0
        totalQty         := 0
        totalCost        := 0
        trailLowestPrice := na
        firstQty         := na
        virtualEntryPrice := na

plot(trailingActive ? trailLowestPrice * (1 + trailingPct) : na, title="ç§»åŠ¨æ­¢ç›ˆè§¦å‘ä»·", color=color.red)

// === å¯è§†åŒ– ===
plot(useEmaFilter ? emaFast : na, title="EMA çŸ­æœŸ", color=color.orange)
plot(useEmaFilter ? emaMid1 : na, title="EMA ä¸­æœŸ1", color=color.blue)
plot(useEmaFilter ? emaMid2 : na, title="EMA ä¸­æœŸ2", color=color.purple)
plot(useEmaFilter ? emaSlow : na, title="EMA é•¿æœŸ", color=color.red)
hline(useRsiFilter ? rsiThreshold : na, title="RSI é˜ˆå€¼", color=color.gray, linestyle=hline.style_dotted)
plot(useRsiFilter ? rsiValue : na, title="RSI å€¼", color=color.teal)
plotshape(inTrade and addCount == 0 and not na(virtualEntryPrice) and close < virtualEntryPrice * (1 - pc_exit), title="è™šæ‹Ÿæ­¢ç›ˆæç¤º", location=location.belowbar, color=color.gray, style=shape.cross, size=size.small)

